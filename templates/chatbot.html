{% extends "layout.html" %}
{% block title %}Chatbot{% endblock %}
{% block content %}

<!-- The main card container for the chat interface -->
<div class="content-card">

    <div class="chat-container">
        <div class="chat-header">
            <h2>Financial Assistant</h2>
            <p>Ask me anything about your finances!</p>
        </div>
        <div class="chat-box" id="chat-box">
            <!-- Initial bot message -->
            <div class="message bot">
                <div class="message-content">Hello! How can I help you manage your finances today?</div>
            </div>
            <!-- Dynamic messages will be appended here -->
        </div>
        <div class="chat-input-area">
            <form id="chat-form">
                <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off" required>
                <button type="submit" id="send-btn" class="btn btn-primary">Send</button>
            </form>
        </div>
    </div>

</div>

<style>
    /* Add some specific styles for the chat UI inside the card */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 70vh; /* Set a height for the chat window */
        max-height: 600px;
    }
    .chat-header {
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }
    .chat-box {
        flex-grow: 1;
        padding: 1rem 0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .message {
        display: flex;
        max-width: 80%;
    }
    .message-content {
        padding: 0.75rem 1.25rem;
        border-radius: 20px;
        line-height: 1.5;
    }
    .message.user {
        align-self: flex-end;
    }
    .message.user .message-content {
        background-color: #FFC107; /* Your primary yellow */
        color: #1a1a1a;
        border-bottom-right-radius: 5px;
    }
    .message.bot {
        align-self: flex-start;
    }
    .message.bot .message-content {
        background-color: #f0f0f0; /* A light grey for the bot */
        color: #333;
        border-bottom-left-radius: 5px;
    }
    .chat-input-area {
        border-top: 1px solid #eee;
        padding-top: 1rem;
    }
    #chat-form {
        display: flex;
        gap: 1rem;
    }
    #user-input {
        flex-grow: 1;
    }
    /* Simple typing indicator */
    .typing .message-content {
        padding: 0.75rem 1.25rem 0.75rem 1rem;
    }
    .typing::after {
        content: '...';
        display: inline-block;
        vertical-align: bottom;
        animation: ellipsis 1.25s infinite;
    }
    @keyframes ellipsis {
        0% { content: '.'; }
        33% { content: '..'; }
        66% { content: '...'; }
    }
</style>

<script>
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');
const chatBox = document.getElementById('chat-box');

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const messageText = userInput.value.trim();
    if (!messageText) return;

    // Display user message
    appendMessage(messageText, 'user');
    userInput.value = '';
    
    // Display typing indicator
    const typingIndicator = appendMessage('', 'bot', true);

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageText })
        });

        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }

        const data = await response.json();
        
        // Remove typing indicator and show bot reply
        typingIndicator.remove();
        appendMessage(data.reply, 'bot');

    } catch (error) {
        console.error('Error:', error);
        typingIndicator.remove();
        appendMessage('Sorry, something went wrong. Please try again.', 'bot');
    }
});

function appendMessage(text, sender, isTyping = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', sender);
    
    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');
    
    if (isTyping) {
        contentDiv.classList.add('typing');
    } else {
        contentDiv.textContent = text;
    }

    messageDiv.appendChild(contentDiv);
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    return messageDiv; // Return the element so it can be removed
}
</script>
{% endblock %}